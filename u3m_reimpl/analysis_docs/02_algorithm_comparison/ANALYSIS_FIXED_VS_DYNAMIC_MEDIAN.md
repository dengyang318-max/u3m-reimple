# 固定中位数 vs 动态中位数：为什么结果差异如此巨大？

## 实验观察

从Chicago Crimes实验结果可以看到：

**固定中位数策略**：
- Best skew: **1.676155**
- Direction: (0.587739, 0.809051)

**动态中位数策略**：
- Best skew: **0.141857**
- Direction: (0.280018, 0.959995)

**差异**：
- Skew difference: **-1.534298**（动态比固定低了约1.5）
- Direction difference (L2 norm): **0.342748**（方向完全不同）

## 核心原因分析

### 1. 中位数点的使用方式不同

#### 固定中位数策略
```python
# 初始化时确定中位数点（只执行一次）
sorted_by_x = sorted(pts, key=lambda p: p.x)
median_point = sorted_by_x[len(sorted_by_x) // 2]  # x坐标的中位数点

# 遍历所有交点时，都用这个固定的中位数点
for x, y in intersections:
    direction = normalize_direction(np.array([x, y], dtype=float))
    skew_val = skew_from_median_point(stats, direction, median_point)  # 始终用同一个median_point
```

**特点**：
- ✅ **简单快速**：只需要初始化一次中位数点
- ❌ **可能不准确**：对于某些方向，这个固定的中位数点可能不是该方向投影的**真正中位数点**

#### 动态中位数策略
```python
# 初始化中位数点
current_median = initial_median

# 沿着k-level arrangement遍历
while intersection_idx < len(current_intersections):
    # 计算当前方向的偏度（使用当前的中位数点）
    skew_val = skew_from_median_point(stats, direction, current_median)
    
    # 在交点处更新中位数点（如果median region发生变化）
    if new_median != current_median:
        current_median = new_median  # 更新中位数点
```

**特点**：
- ✅ **更准确**：每个方向使用其对应的**正确中位数点**
- ✅ **符合理论**：实现了论文中描述的k-level arrangement遍历
- ❌ **更复杂**：需要维护median region的拓扑结构

### 2. 为什么偏度值差异如此巨大？

#### 偏度计算公式
```
skew = |(mean - median) / std|
```

**关键点**：偏度值依赖于**median**（中位数点在该方向上的投影）

#### 场景分析

假设有一个方向 `f = (0.6, 0.8)`：

**固定中位数策略**：
- 使用初始的x-中位数点 `M_fixed = (x_median, y_median)`
- 计算偏度：`skew = |(mean_f - M_fixed · f) / std_f|`
- **问题**：`M_fixed · f` 可能不是该方向投影的**真正中位数**

**动态中位数策略**：
- 沿着k-level arrangement遍历，找到该方向对应的median region
- 使用该region的**正确中位数点** `M_dynamic`
- 计算偏度：`skew = |(mean_f - M_dynamic · f) / std_f|`
- **优势**：`M_dynamic · f` 是该方向投影的**真正中位数**

#### 为什么固定中位数可能"虚高"？

1. **错误的中位数点**：
   - 固定中位数使用x-中位数点，这个点可能在某些方向上**不是投影的中位数**
   - 如果 `M_fixed · f` 远离真正的投影中位数，`|mean - M_fixed · f|` 可能被**高估**

2. **方向依赖性**：
   - 当方向接近垂直（如 `f ≈ (0, 1)`）时，x-中位数点可能完全不适合
   - 当方向接近水平（如 `f ≈ (1, 0)`）时，x-中位数点可能恰好正确

3. **偏度值的误导性**：
   - 固定中位数可能找到"看起来偏度很高"的方向，但这是因为使用了**错误的中位数点**
   - 动态中位数找到的方向偏度可能较低，但这是**真实的偏度**

### 3. 为什么方向完全不同？

从结果看：
- 固定中位数：`(0.587739, 0.809051)` - 偏度1.676155
- 动态中位数：`(0.280018, 0.959995)` - 偏度0.141857

**原因**：

1. **搜索空间不同**：
   - 固定中位数：遍历所有交点，但用**错误的中位数点**评估偏度
   - 动态中位数：沿着k-level arrangement遍历，用**正确的中位数点**评估偏度

2. **偏度排序不同**：
   - 由于中位数点不同，每个方向的偏度值计算不同
   - 导致**偏度排序完全不同**，top-1方向自然不同

3. **固定中位数可能找到"伪高偏度"方向**：
   - 某个方向可能因为使用了错误的中位数点而显得偏度很高
   - 但实际上，如果使用正确的中位数点，偏度可能很低

### 4. 具体例子说明

假设有500个点，方向 `f = (0.6, 0.8)`：

**固定中位数**：
- 使用x-中位数点 `M_fixed = (0.5, 0.5)`
- 投影中位数：`M_fixed · f = 0.5 * 0.6 + 0.5 * 0.8 = 0.7`
- 但真正的投影中位数可能是 `0.3`（因为数据在该方向上分布不均匀）
- 如果 `mean_f = 0.4`，`std_f = 0.1`：
  - 固定中位数偏度：`|0.4 - 0.7| / 0.1 = 3.0`（虚高！）
  - 真实偏度：`|0.4 - 0.3| / 0.1 = 1.0`

**动态中位数**：
- 找到该方向对应的median region
- 使用正确的中位数点，投影中位数 `= 0.3`
- 计算偏度：`|0.4 - 0.3| / 0.1 = 1.0`（真实值）

## 结论

### 为什么差异如此巨大？

1. **中位数点的选择不同**：
   - 固定中位数：所有方向用同一个点（x-中位数点）
   - 动态中位数：每个方向用其对应的正确中位数点

2. **偏度计算的准确性不同**：
   - 固定中位数可能在某些方向上**高估**偏度（因为使用了错误的中位数点）
   - 动态中位数计算的是**真实偏度**

3. **搜索策略不同**：
   - 固定中位数：遍历所有交点，但评估可能不准确
   - 动态中位数：沿着k-level arrangement遍历，评估更准确

### 哪个结果更可信？

**动态中位数的结果更可信**，因为：
- ✅ 使用了每个方向对应的**正确中位数点**
- ✅ 实现了论文中描述的**标准Ray-sweeping算法**
- ✅ 偏度值反映的是**真实的分布偏度**

**固定中位数的结果**：
- ⚠️ 可能在某些方向上**高估**偏度
- ⚠️ 找到的"高偏度方向"可能是**伪高偏度**（因为使用了错误的中位数点）
- ⚠️ 但仍然可能找到一些有意义的模式

### 实际意义

从实验结果看：
- **固定中位数**找到的方向偏度1.676155，但这可能是"虚高"
- **动态中位数**找到的方向偏度0.141857，这是**真实偏度**

**建议**：
- 如果要找到**真正的高偏度方向**，应该使用**动态中位数策略**
- 固定中位数策略可以作为快速近似，但结果需要谨慎解释

## 技术细节

### Median Region概念

在Ray-sweeping算法中：
- **Median Region**：在某个方向范围内，投影的中位数点保持不变的区域
- **Region边界**：当方向变化到某个临界值时，投影的中位数点会发生变化
- **k-level arrangement**：所有median region的边界形成的拓扑结构

### 为什么需要动态更新？

1. **方向依赖性**：不同方向的投影中位数点可能不同
2. **Region边界**：当方向跨越region边界时，中位数点必须更新
3. **准确性**：只有使用正确的中位数点，偏度计算才准确

### 固定中位数的局限性

固定中位数策略假设：
- "所有方向的投影中位数点都相同"（使用x-中位数点）

但这个假设**通常不成立**，因为：
- 不同方向的投影会重新排列点的顺序
- 投影的中位数点会随着方向变化而变化

因此，固定中位数策略在某些方向上会**高估或低估**偏度，导致找到的"高偏度方向"可能不准确。

